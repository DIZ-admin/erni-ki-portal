<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Metaprompting Studio ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∫–∞–Ω–≤–∞—Å</title>
  <style>
    :root{
      --bg:#0b0d12; --panel:#141824; --muted:#98a2b3; --text:#e7e7ea; --accent:#7cd2ff; --lines:#212838;
      --good:#57d2a6; --warn:#f6c948; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    a { color: var(--accent); text-decoration: none; }
    header {
      position: sticky; top:0; z-index:3;
      background: linear-gradient(180deg, rgba(7,8,12,0.9), rgba(7,8,12,0.6));
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--lines);
      padding: 10px 16px;
      display:flex; align-items:center; gap:12px; justify-content:space-between;
    }
    header .title { font-weight:700; letter-spacing:.2px }
    header .hint { font-size:12px; color:var(--muted) }
    .container { display:grid; grid-template-columns: 320px 1fr 420px; gap:14px; padding:14px; height: calc(100% - 56px); }
    @media (max-width: 1200px){
      .container{ grid-template-columns: 1fr; height:auto }
      #left, #center, #right{ position:static; height:auto }
    }
    .panel { background: var(--panel); border:1px solid var(--lines); border-radius: 14px; overflow:hidden; display:flex; flex-direction:column; min-height: 200px; }
    .panel h3 { margin:0; padding:12px 14px; border-bottom:1px solid var(--lines); font-size:14px; letter-spacing:.3px; text-transform:uppercase; color:#b9c1d6; }
    .panel .content { padding:12px; overflow:auto; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    label { font-size:12px; color:#b9c1d6; margin-bottom:6px; display:block }
    input[type=text], textarea, select, input[type=number]{
      width:100%; background:#0f1320; border:1px solid #252d42; color:var(--text); border-radius:10px; padding:9px 10px; outline:none;
    }
    textarea{ min-height:76px; resize:vertical }
    .small{ font-size:12px; color:var(--muted) }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#0f1422; border:1px solid #27314d; border-radius:20px; font-size:12px; color:#bcc6da; margin:4px 6px 0 0; cursor:pointer; user-select:none }
    .pill input{ margin-right:6px }
    .btn {
      padding:10px 12px; border-radius:10px; border:1px solid #2b3650; background:#0f1320; color:var(--text); cursor:pointer;
    }
    .btn:hover{ background:#12182a }
    .btn.primary{ border-color:#2b415a; background:linear-gradient(180deg,#12304a,#0f2436); }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap }
    .stack{ display:flex; flex-direction:column; gap:10px }
    .ghost{ opacity:.8 }
    .muted{ color:var(--muted) }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#0b0f1a; border:1px solid #253352; padding:1px 6px; border-radius:6px; font-size:12px }
    pre{ background:#0b0f1a; border:1px solid #262e46; color:#e8ebf2; border-radius:12px; padding:12px; overflow:auto; }
    code{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:13px; }
    .badge{ font-size:11px; color:#a5b0c7; border:1px solid #2a3550; padding:4px 8px; border-radius:999px; background:#0d1422; }
    .list{ display:flex; flex-wrap:wrap; gap:6px; }
    .hr{ height:1px; background:var(--lines); margin:10px 0 }
    .ok{ color:var(--good) } .warn{ color:var(--warn) } .bad{ color:var(--bad) }
    .ghost-box{ padding:10px; border:1px dashed #36405d; border-radius:10px; color:#8ea0bf; background:#0b0f1a }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">üß≠ Metaprompting Studio</div>
      <div class="hint">–°–æ–±–∏—Ä–∞–π –º–µ—Ç–∞–ø—Ä–æ–º–ø—Ç –∏–∑ –±–ª–æ–∫–æ–≤ ‚Üí –ø–æ–ª—É—á–∞–π –≥–æ—Ç–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º.</div>
    </div>
    <div class="toolbar">
      <button class="btn" id="btnShare">–°—Å—ã–ª–∫–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏</button>
      <button class="btn" id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
      <label class="btn" style="position:relative; overflow:hidden">
        –ò–º–ø–æ—Ä—Ç JSON<input type="file" id="fileImport" accept="application/json" style="position:absolute; inset:0; opacity:0; cursor:pointer" />
      </label>
      <button class="btn primary" id="btnCopy">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç</button>
    </div>
  </header>

  <div class="container">
    <!-- LEFT: Builder -->
    <section id="left" class="panel">
      <h3>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</h3>
      <div class="content stack">
        <div class="row">
          <div class="stack">
            <label>–†–æ–ª—å</label>
            <input id="role" type="text" placeholder="–ü—Ä–∏–º–µ—Ä: –°—Ç–∞—Ä—à–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–µ–ª–æ–≤–æ–≥–æ —Å—Ç–∏–ª—è" />
          </div>
          <div class="stack">
            <label>–ê—É–¥–∏—Ç–æ—Ä–∏—è</label>
            <input id="audience" type="text" placeholder="–ü—Ä–∏–º–µ—Ä: –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–∏ –º–∞–ª–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞" />
          </div>
        </div>

        <div class="stack">
          <label>–¶–µ–ª—å (Goal)</label>
          <textarea id="goal" placeholder="–ö–∞–∫–æ–π —Ü–µ–ª—å –¥–æ–ª–∂–Ω–∞ –¥–æ—Å—Ç–∏—á—å –º–æ–¥–µ–ª—å?"></textarea>
        </div>

        <div class="stack">
          <label>–ö–æ–Ω—Ç–µ–∫—Å—Ç</label>
          <textarea id="context" placeholder="–§–∞–∫—Ç—ã, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ–º–µ–Ω–∞, –≤–≤–æ–¥–Ω—ã–µ‚Ä¶"></textarea>
        </div>

        <div class="row">
          <div class="stack">
            <label>–¢–æ–Ω</label>
            <select id="tone">
              <option value="">‚Äî</option>
              <option>–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π</option>
              <option>–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π</option>
              <option>–¥–µ–ª–æ–≤–æ–π</option>
              <option>—ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π</option>
              <option>—É—á–µ–±–Ω—ã–π</option>
              <option>–ª–∞–∫–æ–Ω–∏—á–Ω—ã–π</option>
            </select>
          </div>
          <div class="stack">
            <label>–î–ª–∏–Ω–∞/–û–±—ä–µ–º</label>
            <select id="length">
              <option value="">‚Äî</option>
              <option>–æ—á–µ–Ω—å –∫—Ä–∞—Ç–∫–æ</option>
              <option>–∫—Ä–∞—Ç–∫–æ</option>
              <option>—Å—Ä–µ–¥–Ω–µ</option>
              <option>–ø–æ–¥—Ä–æ–±–Ω–æ</option>
            </select>
          </div>
        </div>

        <div class="stack">
          <label>–í—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (placeholder)</label>
          <input id="userInputPlaceholder" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: {{—Ç–µ–º–∞}} –∏–ª–∏ {{—Ç–µ–∫—Å—Ç}}" />
          <div class="small muted">–≠—Ç–æ—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –ø–æ—è–≤–∏—Ç—Å—è –≤ —Å–µ–∫—Ü–∏–∏ <span class="kbd>{{input}}</span> –∏ –ø–æ–º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ—Ç–∞–ø—Ä–æ–º–ø—Ç –∫–∞–∫ —à–∞–±–ª–æ–Ω.</div>
        </div>

        <div class="stack">
          <label>–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞</label>
          <div class="row">
            <select id="format">
              <option>—Å–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç</option>
              <option>–º–∞—Ä–∫–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫</option>
              <option>—Ç–∞–±–ª–∏—Ü–∞ (Markdown)</option>
              <option>JSON</option>
            </select>
            <input id="formatSchema" type="text" placeholder='JSON-–∫–ª—é—á–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é): title,summary,bullets[]' />
          </div>
          <div class="small muted">–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω JSON ‚Äî —É–∫–∞–∂–∏ –∫–ª—é—á–∏. –ú–∞—Å—Å–∏–≤—ã –ø–æ–º–µ—á–∞–π <span class="kbd">[]</span>, –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É: <span class="kbd">items[].title</span>.</div>
        </div>

        <div class="stack">
          <label>–ü—Ä–∞–≤–∏–ª–∞ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</label>
          <div id="rules" class="list"></div>
          <div class="toolbar">
            <input id="ruleInput" type="text" placeholder="–î–æ–±–∞–≤—å –ø—Ä–∞–≤–∏–ª–æ –∏ –Ω–∞–∂–º–∏ +">
            <button class="btn" id="addRule">+</button>
          </div>
          <div class="small muted">–ü—Ä–∏–º–µ—Ä: ¬´–Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è¬ª, ¬´–µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Äî –∑–∞–¥–∞—Ç—å –¥–æ 3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤¬ª.</div>
        </div>

        <div class="row">
          <div class="stack">
            <label>–ü—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ (checklist)</label>
            <div id="checks" class="list"></div>
            <div class="toolbar">
              <input id="checkInput" type="text" placeholder="–î–æ–±–∞–≤—å –ø—É–Ω–∫—Ç –∏ –Ω–∞–∂–º–∏ +">
              <button class="btn" id="addCheck">+</button>
            </div>
          </div>
          <div class="stack">
            <label>–ü–æ–ª–∏—Ç–∏–∫–∞ —Å—Å—ã–ª–æ–∫/—Ü–∏—Ç–∞—Ç</label>
            <select id="citation">
              <option>–±–µ–∑ —Å—Å—ã–ª–æ–∫</option>
              <option>—É–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)</option>
              <option>—Å—Ç—Ä–æ–≥–∏–µ —Ü–∏—Ç–∞—Ç—ã —Å –∞—Ç—Ä–∏–±—É—Ü–∏–µ–π</option>
            </select>
            <label style="margin-top:10px">–£—Ç–æ—á–Ω–µ–Ω–∏–µ</label>
            <input id="citationNote" type="text" placeholder="—Ñ–æ—Ä–º–∞—Ç —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —á–∏—Å–ª–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ —Ç.–ø.">
          </div>
        </div>

        <div class="row">
          <div class="stack">
            <label>–°—Ç–µ–ø–µ–Ω—å —Å–≤–æ–±–æ–¥—ã (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞)</label>
            <input id="temperature" type="number" min="0" max="2" step="0.1" value="0.7">
          </div>
          <div class="stack">
            <label>–£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã</label>
            <select id="clarify">
              <option>–Ω–µ –∑–∞–¥–∞–≤–∞—Ç—å</option>
              <option selected>–¥–æ 3 –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º</option>
              <option>–≤—Å–µ–≥–¥–∞ —Å–ø—Ä–æ—Å–∏—Ç—å 1‚Äì2 –∫–ª—é—á–µ–≤—ã—Ö —É—Ç–æ—á–Ω–µ–Ω–∏—è</option>
            </select>
          </div>
        </div>

        <div class="stack">
          <label>–ê–Ω—Ç–∏-—Ü–µ–ª–∏ (—á—Ç–æ —Ç–æ—á–Ω–æ –Ω–µ –¥–µ–ª–∞—Ç—å)</label>
          <textarea id="antiGoals" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∏–∑–±–µ–≥–∞—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤; –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ; –Ω–µ ¬´–≥–∞–ª–ª—é—Ü–∏–Ω–∏—Ä–æ–≤–∞—Ç—å¬ª —Ü–∏—Ñ—Ä—ã."></textarea>
        </div>
      </div>
    </section>

    <!-- CENTER: Prompt Preview -->
    <section id="center" class="panel">
      <h3>–°–±–æ—Ä–∫–∞ –º–µ—Ç–∞–ø—Ä–æ–º–ø—Ç–∞ (–ø—Ä–µ–≤—å—é)</h3>
      <div class="content">
        <div class="toolbar" style="margin-bottom:10px">
          <button class="btn" id="btnLibrary">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤</button>
          <button class="btn" id="btnAgents">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–±–æ—Ä –∏–∑ 3 –∞–≥–µ–Ω—Ç–æ–≤</button>
          <span class="badge ghost">—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –Ω–µ –ø—Ä–æ—Å–∏ ¬´–ø–æ–∫–∞–∂–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è¬ª ‚Äî –ª—É—á—à–µ ¬´–∫—Ä–∞—Ç–∫–æ –æ–±–æ—Å–Ω—É–π¬ª</span>
        </div>
        <pre id="preview"><code></code></pre>
        <div class="hr"></div>
        <div class="ghost-box small">–ü–æ–¥—Å–∫–∞–∑–∫–∞: —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π —Å–ª–µ–≤–∞ ‚Äî –ø—Ä–µ–≤—å—é –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ. –ö–Ω–æ–ø–∫–æ–π ¬´–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç¬ª –æ—Ç–ø—Ä–∞–≤—å –≤ –ª—é–±—É—é LLM.</div>
      </div>
    </section>

    <!-- RIGHT: Guidance & Patterns -->
    <section id="right" class="panel">
      <h3>–ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏ —Å–æ–≤–µ—Ç—ã</h3>
      <div class="content stack">
        <div class="stack">
          <div class="badge">–ü–∞—Ç—Ç–µ—Ä–Ω—ã</div>
          <div class="list" id="patterns"></div>
        </div>
        <div class="hr"></div>
        <div class="stack">
          <div class="badge">–ù–∞–±–æ—Ä—ã</div>
          <div class="list" id="bundles"></div>
        </div>
        <div class="hr"></div>
        <div class="stack">
          <div class="badge">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</div>
          <ul class="small muted" id="diag"></ul>
        </div>
      </div>
    </section>
  </div>

  <script>
    // --- State ---
    const state = {
      role: "–≠–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–µ",
      audience: "–æ—Å–Ω–æ–≤–∞—Ç–µ–ª–∏ —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤",
      goal: "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ A/B —Å —á—ë—Ç–∫–∏–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ —É—Å–ø–µ—Ö–∞.",
      context: "–£ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤–µ–±‚Äë–ø–∞–Ω–µ–ª—å –∏ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –û–ø–æ—Ä–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞ ‚Äî –∫–æ–Ω–≤–µ—Ä—Å–∏—è –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.",
      tone: "–¥–µ–ª–æ–≤–æ–π",
      length: "–∫—Ä–∞—Ç–∫–æ",
      userInputPlaceholder: "{{–≥–∏–ø–æ—Ç–µ–∑–∞}}",
      format: "–º–∞—Ä–∫–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫",
      formatSchema: "title,steps[].text,risks[]",
      rules: [
        "–Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è; –¥–∞–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤—ã–≤–æ–¥—ã –∏ –∫—Ä–∞—Ç–∫–∏–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è",
        "–µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Äî –∑–∞–¥–∞—Ç—å –¥–æ 2 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤",
        "–Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å —Ü–∏—Ñ—Ä—ã; –≥–¥–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —É–∫–∞–∑–∞—Ç—å –¥–æ–ø—É—â–µ–Ω–∏–µ"
      ],
      checks: [
        "–∫–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –∏–∑–º–µ—Ä–∏–º–æ—Å—Ç—å",
        "—Å—Ä–æ–∫–∏ –∏ –≤–ª–∞–¥–µ–ª—å—Ü—ã –æ–±–æ–∑–Ω–∞—á–µ–Ω—ã",
        "–Ω–µ –±–æ–ª–µ–µ 8 –ø—É–Ω–∫—Ç–æ–≤"
      ],
      citation: "—É–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)",
      citationNote: "",
      temperature: 0.7,
      clarify: "–¥–æ 3 –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º",
      antiGoals: "–ò–∑–±–µ–≥–∞—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤; –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ."
    };

    // --- Utils ---
    const $ = (sel)=> document.querySelector(sel);
    const el = (tag, props={}, children=[])=>{
      const n = Object.assign(document.createElement(tag), props);
      children.forEach(c=> n.appendChild(typeof c==='string' ? document.createTextNode(c) : c));
      return n;
    };
    const escape = (s)=> String(s||"").replace(/[<>&]/g, m=>({"<":"&lt;",">":"&gt;","&":"&amp;"})[m]);
    const b64 = {
      encode: (obj)=> btoa(unescape(encodeURIComponent(JSON.stringify(obj)))),
      decode: (s)=> JSON.parse(decodeURIComponent(escape(atob(s))))
    };

    function saveLocal(){ localStorage.setItem("metaprompting-studio", JSON.stringify(state)); }
    function loadLocal(){
      const raw = localStorage.getItem("metaprompting-studio");
      if (!raw) return;
      try{ Object.assign(state, JSON.parse(raw)); }catch(e){}
    }

    function updatePreview(){
      const lines = [];
      if (state.role) lines.push(`## –†–æ–ª—å\n${state.role}`);
      if (state.audience) lines.push(`## –ê—É–¥–∏—Ç–æ—Ä–∏—è\n${state.audience}`);
      if (state.goal) lines.push(`## –¶–µ–ª—å\n${state.goal}`);
      if (state.context) lines.push(`## –ö–æ–Ω—Ç–µ–∫—Å—Ç\n${state.context}`);
      if (state.tone || state.length){
        const tone = state.tone ? `—Ç–æ–Ω: ${state.tone}` : "";
        const len = state.length ? `–æ–±—ä–µ–º: ${state.length}` : "";
        lines.push(`## –°—Ç–∏–ª—å\n${[tone,len].filter(Boolean).join("; ")}`);
      }
      if (state.clarify && state.clarify!=="–Ω–µ –∑–∞–¥–∞–≤–∞—Ç—å"){
        lines.push(`## –£—Ç–æ—á–Ω–µ–Ω–∏—è\n${state.clarify}. –ï—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ ‚Äî —Å–ø—Ä–æ—Å–∏ –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º.`);
      }
      if (state.rules?.length){
        lines.push("## –ü—Ä–∞–≤–∏–ª–∞");
        lines.push(state.rules.map((r,i)=> `${i+1}. ${r}`).join("\n"));
      }
      if (state.citation && state.citation!=="–±–µ–∑ —Å—Å—ã–ª–æ–∫"){
        lines.push(`## –ò—Å—Ç–æ—á–Ω–∏–∫–∏\n${state.citation}${state.citationNote? " ‚Äî " + state.citationNote : ""}.`);
      }
      if (state.antiGoals){
        lines.push(`## –ê–Ω—Ç–∏‚Äë—Ü–µ–ª–∏\n${state.antiGoals}`);
      }
      // Output format
      const fmt = state.format || "—Å–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç";
      if (fmt==="JSON" && state.formatSchema){
        const schema = state.formatSchema.split(",").map(s=> s.trim()).filter(Boolean);
        lines.push("## –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞\n–í–µ—Ä–Ω–∏ —Å—Ç—Ä–æ–≥–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏:");
        lines.push(schema.map(k=> `- ${k}`).join("\n"));
      } else {
        lines.push(`## –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞\n${fmt}`);
      }
      // Temperature as guidance (not API)
      lines.push(`## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏\n–æ—Ä–∏–µ–Ω—Ç–∏—Ä: temperature ‚âà ${state.temperature}`);

      // Input placeholder
      if (state.userInputPlaceholder){
        lines.push("## –í–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
        lines.push(`–ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–π –≤–≤–æ–¥: ${state.userInputPlaceholder}\n–ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –∑–∞–ø—Ä–æ—Å–∏.`);
      }
      // Final instruction + safeguard
      lines.push("## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è\n–°–Ω–∞—á–∞–ª–∞ —É–±–µ–¥–∏—Å—å, —á—Ç–æ –∑–∞–¥–∞—á–∞ –ø–æ–Ω—è—Ç–Ω–∞. –ó–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏ –∏ –≤–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ –∫–æ–Ω–µ—á–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–æ–≥–ª–∞—Å–Ω–æ —Ñ–æ—Ä–º–∞—Ç—É. –ö—Ä–∞—Ç–∫–æ –æ–±–æ—Å–Ω—É–π –∫–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –±–µ–∑ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π.");
      const composed = lines.join("\n\n");
      $("#preview code").textContent = composed;
      runDiag();
      saveLocal();
    }

    // --- Form wiring ---
    function bindInputs(){
      const bind = (id, key, transform=(v)=>v)=>{
        const node = document.getElementById(id);
        if (!node) return;
        node.value = state[key] ?? "";
        node.addEventListener("input", ()=>{ state[key] = transform(node.value); updatePreview(); });
      };
      bind("role","role"); bind("audience","audience"); bind("goal","goal");
      bind("context","context"); bind("tone","tone"); bind("length","length");
      bind("userInputPlaceholder","userInputPlaceholder");
      bind("format","format");
      bind("formatSchema","formatSchema");
      bind("citation","citation");
      bind("citationNote","citationNote");
      bind("temperature","temperature", v=> +v);
      bind("clarify","clarify");
      bind("antiGoals","antiGoals");

      // rules / checks
      const rules = $("#rules");
      const checks = $("#checks");
      function renderTags(listNode, arr, colorClass){
        listNode.innerHTML = "";
        arr.forEach((text, idx)=>{
          const pill = el("span", {className:"pill"}, [
            el("span", {textContent: text}),
            el("a", {textContent:"‚úï", className:"muted", href:"#", onclick:(e)=>{e.preventDefault(); arr.splice(idx,1); renderTags(listNode, arr); updatePreview();}})
          ]);
          listNode.appendChild(pill);
        });
      }
      renderTags(rules, state.rules, "");
      renderTags(checks, state.checks, "");

      $("#addRule").addEventListener("click", ()=>{
        const v = $("#ruleInput").value.trim(); if(!v) return;
        state.rules.push(v); $("#ruleInput").value=""; renderTags(rules, state.rules); updatePreview();
      });
      $("#addCheck").addEventListener("click", ()=>{
        const v = $("#checkInput").value.trim(); if(!v) return;
        state.checks.push(v); $("#checkInput").value=""; renderTags(checks, state.checks); updatePreview();
      });
    }

    // --- Patterns & bundles ---
    const patternList = [
      { name:"Clarify‚ÄëThen‚ÄëAnswer", text:"–ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–µ–ø–æ–ª–Ω–∞—è ‚Äî –∑–∞–¥–∞–π –¥–æ N —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, –∑–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏." },
      { name:"Rubric‚ÄëFirst", text:"–°–Ω–∞—á–∞–ª–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–π –∫—Ä–∏—Ç–µ—Ä–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞, –∑–∞—Ç–µ–º –¥–µ–π—Å—Ç–≤—É–π –≤ –∏—Ö —Ä–∞–º–∫–∞—Ö." },
      { name:"Few‚ÄëShot‚ÄëCompact", text:"–í–∫–ª—é—á–∏ 2‚Äì3 –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–∏–º–µ—Ä–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ—Ö–æ–∂–∏—Ö –Ω–∞ —Ü–µ–ª–µ–≤–æ–π —Å–ª—É—á–∞–π." },
      { name:"Socratic‚ÄëTutor", text:"–û—Ç–≤–µ—á–∞–π –≤–æ–ø—Ä–æ—Å–æ–º –Ω–∞ –≤–æ–ø—Ä–æ—Å, –ø–æ–¥–≤–æ–¥—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –æ—Ç–≤–µ—Ç—É. –§–∏–Ω–∞–ª ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ —Ä–µ–∑—é–º–µ." },
      { name:"Guardrails‚ÄëLite", text:"–ü–µ—Ä–µ—á–∏—Å–ª–∏ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã; –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏." },
      { name:"Planner‚ÄëExecutor", text:"–†–∞–∑–¥–µ–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–ª–∞–Ω (–∫–æ—Ä–æ—Ç–∫–æ) –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ; –ø–ª–∞–Ω –Ω–µ –≤–∫–ª—é—á–∞—Ç—å –≤ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç." },
      { name:"Reviewer‚ÄëLoop", text:"–ü–æ—Å–ª–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä—å —á–µ–∫‚Äë–ª–∏—Å—Ç –∏ —É–ª—É—á—à–∞–π –¥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è, –∑–∞—Ç–µ–º –≤–µ—Ä–Ω–∏ –∏—Ç–æ–≥." },
      { name:"Citations‚ÄëStrict", text:"–¢—Ä–µ–±—É–π —É–∫–∞–∑–∞–Ω–∏—è 2‚Äì3 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤; –±–µ–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ ‚Äî –ø–æ–º–µ—Ç–∫–∞ ¬´–Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ¬ª." }
    ];

    const bundles = [
      {
        name:"–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ ‚Üí –°–∏–Ω—Ç–µ–∑ ‚Üí –í—ã–≤–æ–¥",
        items:[
          "–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å: —Å–æ–±–µ—Ä–∏ —Ñ–∞–∫—Ç—ã –∏ —Ç–µ—Ä–º–∏–Ω—ã; –ø–µ—Ä–µ—á–∏—Å–ª–∏ –ø—Ä–æ–±–µ–ª—ã –≤ –¥–∞–Ω–Ω—ã—Ö.",
          "–°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –≤ 3‚Äì5 —Ç–µ–∑–∏—Å–æ–≤ –∏ —Å—Ä–∞–≤–Ω–∏ –≥–∏–ø–æ—Ç–µ–∑—ã.",
          "–ö–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä: –ø–æ–¥–≥–æ—Ç–æ–≤—å –≤—ã–≤–æ–¥ –¥–ª—è —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏."
        ]
      },
      {
        name:"–¢—Ä–∏–æ: –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ / –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å / –ö—Ä–∏—Ç–∏–∫",
        items:[
          "–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫: —Ä–∞–∑–ª–æ–∂–∏ –∑–∞–¥–∞—á—É –Ω–∞ —à–∞–≥–∏ –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞.",
          "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: —Ä–µ–∞–ª–∏–∑—É–π —à–∞–≥–∏, –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π.",
          "–ö—Ä–∏—Ç–∏–∫: –ø—Ä–æ–≤–µ—Ä—å —á–µ–∫‚Äë–ª–∏—Å—Ç –∏ —É–ª—É—á—à–∞–π –∏—Ç–æ–≥."
        ]
      },
      {
        name:"–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑",
        items:[
          "–§—Ä–µ–π–º–∏–Ω–≥ –ø—Ä–æ–±–ª–µ–º—ã (–∫—Ç–æ, —á—Ç–æ, –ø–æ—á–µ–º—É).",
          "–ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞ –∏ —Ä–∏—Å–∫–∏.",
          "–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–ª–∞–Ω —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞."
        ]
      }
    ];

    function renderPatterns(){
      const root = $("#patterns"); root.innerHTML="";
      patternList.forEach(p=>{
        const btn = el("button", {className:"btn", textContent:p.name, title:p.text});
        btn.addEventListener("click", ()=>{
          state.rules.push(p.text);
          updatePreview();
          bindInputs(); // re-render tags
        });
        root.appendChild(btn);
      });
    }

    function renderBundles(){
      const root = $("#bundles"); root.innerHTML="";
      bundles.forEach(b=>{
        const btn = el("button", {className:"btn", textContent:b.name});
        btn.addEventListener("click", ()=>{
          state.checks = state.checks.concat(b.items);
          updatePreview();
          bindInputs();
        });
        root.appendChild(btn);
      });
    }

    // --- Diagnostics ---
    function runDiag(){
      const out = $("#diag"); out.innerHTML="";
      const notes = [];
      if ((state.format==="JSON") && !state.formatSchema.trim()){
        notes.push(["–£–∫–∞–∑–∞–Ω JSON –±–µ–∑ —Å—Ö–µ–º—ã –∫–ª—é—á–µ–π", "warn"]);
      }
      if ((state.rules||[]).join(" ").length > 700){
        notes.push(["–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø—Ä–∞–≤–∏–ª ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —á–∞—Å—Ç—å –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ", "warn"]);
      }
      if ((state.goal||"").length < 10){
        notes.push(["–¶–µ–ª—å –≤—ã–≥–ª—è–¥–∏—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–π. –£—Ç–æ—á–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏.", "warn"]);
      }
      if ((state.citation!=="–±–µ–∑ —Å—Å—ã–ª–æ–∫") && !/–∏—Å—Ç–æ—á/i.test((state.rules||[]).join(" "))){
        notes.push(["–ó–∞–ø—Ä–æ—à–µ–Ω—ã –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –Ω–æ –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö –Ω–µ—Ç —É—Ç–æ—á–Ω–µ–Ω–∏–π –æ —Ñ–æ—Ä–º–∞—Ç–µ/–Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏.", "ghost"]);
      }
      if (!state.userInputPlaceholder){
        notes.push(["–î–æ–±–∞–≤—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –≤—Ö–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä {{—Ç–µ–º–∞}}), —á—Ç–æ–±—ã –º–µ—Ç–∞–ø—Ä–æ–º–ø—Ç –±—ã–ª –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º", "ghost"]);
      }
      if (notes.length===0) notes.push(["–í—Å—ë –≤—ã–≥–ª—è–¥–∏—Ç —Ö–æ—Ä–æ—à–æ. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π –Ω–∞ 2‚Äì3 —Ä–∞–∑–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö.", "ok"]);
      notes.forEach(([text,kind])=>{
        const li = el("li", {textContent:text}); li.className = kind;
        out.appendChild(li);
      });
    }

    // --- Actions ---
    function copyPrompt(){
      const text = $("#preview code").textContent;
      navigator.clipboard.writeText(text).then(()=>{
        toast("–ü—Ä–æ–º–ø—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω ‚úÖ");
      }, ()=>{
        toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –í—ã–¥–µ–ª–∏ –∏ —Å–∫–æ–ø–∏—Ä—É–π –≤—Ä—É—á–Ω—É—é.");
      });
    }
    function exportJSON(){
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = el("a", {href:url, download:"metaprompting_studio.json"});
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 0);
    }
    function importJSON(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const obj = JSON.parse(reader.result);
          Object.assign(state, obj);
          bindInputs();
          updatePreview();
          toast("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ");
        } catch(e){ toast("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞"); }
      };
      reader.readAsText(file);
    }
    function shareLink(){
      const hash = b64.encode(state);
      const url = location.origin + location.pathname + "#" + hash;
      navigator.clipboard.writeText(url).then(()=> toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞"), ()=> toast("–°–∫–æ–ø–∏—Ä—É–π –∏–∑ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏"));
      history.replaceState(null, "", "#" + hash);
    }
    function loadFromHash(){
      if (!location.hash.slice(1)) return;
      try{
        const obj = b64.decode(location.hash.slice(1));
        Object.assign(state, obj);
      }catch(e){}
    }

    function generateAgentSet(){
      const base = {
        domain: state.context || "–£—Ç–æ—á–Ω–∏—Ç—å –¥–æ–º–µ–Ω –∏–∑ –≤—Ö–æ–¥–∞",
        output: state.format || "—Å–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç",
        checklist: (state.checks||[]).slice(0,3).join("; ")
      };
      const agents = [
`### –ê–≥–µ–Ω—Ç 1: –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
–†–æ–ª—å: —Å–∏—Å—Ç–µ–º–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫. –¶–µ–ª—å: —Ä–∞–∑–ª–æ–∂–∏—Ç—å –∑–∞–¥–∞—á—É –Ω–∞ —à–∞–≥–∏ –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞.
–§–æ—Ä–º–∞—Ç: —Å–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤ –∏ —Ä–∏—Å–∫–æ–≤.
–ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–π –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è.
`,
`### –ê–≥–µ–Ω—Ç 2: –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
–†–æ–ª—å: –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç. –¶–µ–ª—å: –≤—ã–ø–æ–ª–Ω–∏—Ç—å —à–∞–≥–∏.
–§–æ—Ä–º–∞—Ç: ${base.output}. –°–æ–±–ª—é–¥–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: ${base.domain}.
`,
`### –ê–≥–µ–Ω—Ç 3: –ö—Ä–∏—Ç–∏–∫
–†–æ–ª—å: –∫–æ–Ω—Ç—Ä–æ–ª—ë—Ä –∫–∞—á–µ—Å—Ç–≤–∞. –¶–µ–ª—å: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ —É–ª—É—á—à–∏—Ç—å.
–ß–µ–∫‚Äë–ª–∏—Å—Ç: ${base.checklist || "–ª–æ–≥–∏—á–Ω–æ—Å—Ç—å; –ø–æ–ª–Ω–æ—Ç–∞; –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞"}
–í—ã–≤–æ–¥: —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –æ—Ç–≤–µ—Ç–∞.`
      ];
      $("#preview code").textContent = agents.join("\n");
      toast("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞–±–æ—Ä –∏–∑ 3 –∞–≥–µ–Ω—Ç–æ–≤");
    }

    // Tiny toast
    let toastTimer;
    function toast(text){
      let t = document.getElementById("toast");
      if (!t){
        t = el("div", {id:"toast"});
        Object.assign(t.style, {
          position:"fixed", right:"16px", bottom:"16px", background:"#0f1422", color:"#e8eef7",
          border:"1px solid #27314d", padding:"10px 12px", borderRadius:"10px", zIndex:99
        });
        document.body.appendChild(t);
      }
      t.textContent = text; t.style.opacity="1";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> t.style.opacity="0", 1600);
    }

    // --- Library ---
    const templates = [
      {
        name:"–û–±—â–∏–π —à–∞–±–ª–æ–Ω –∑–∞–¥–∞—á–∏",
        apply: ()=>{
          state.role = "–≠–∫—Å–ø–µ—Ä—Ç‚Äë–ø—Ä–∞–∫—Ç–∏–∫ –ø–æ —Ç–µ–º–µ";
          state.goal = "–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞—á—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∏–∑–º–µ—Ä–∏–º—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º";
          state.context = "–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º; –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ ‚Äî –∑–∞–ø—Ä–æ—Å–∏—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏—è";
          state.rules = [
            "–Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è; –∫—Ä–∞—Ç–∫–∏–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è –¥–æ–ø—É—Å—Ç–∏–º—ã",
            "–µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Äî –∑–∞–¥–∞—Ç—å –¥–æ 3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤",
            "–Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å —Ñ–∞–∫—Ç—ã; —è–≤–Ω–æ –ø–æ–º–µ—á–∞—Ç—å –¥–æ–ø—É—â–µ–Ω–∏—è"
          ];
          state.checks = ["—è—Å–Ω–æ—Å—Ç—å", "–ø–æ–ª–Ω–æ—Ç–∞", "–∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞"];
          state.format = "—Å–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç";
          state.userInputPlaceholder = "{{–≤–≤–æ–¥}}";
        }
      },
      {
        name:"–ö–æ–¥‚Äë—Ñ–∏–∫—Å: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ç—á",
        apply: ()=>{
          state.role = "–°—Ç–∞—Ä—à–∏–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫";
          state.goal = "–ù–∞–π—Ç–∏ –∏ –ø–æ—á–∏–Ω–∏—Ç—å –±–∞–≥ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –¥–∏—Ñ—Ñ–æ–º";
          state.context = "–ü—Ä–æ–µ–∫—Ç –Ω–∞ TypeScript; —Ç–µ—Å—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ";
          state.rules = [
            "–≤–µ—Ä–Ω—É—Ç—å —Ç–æ–ª—å–∫–æ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –¥–∏—Ñ—Ñ –∏ –∫—Ä–∞—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
            "–Ω–µ –º–µ–Ω—è—Ç—å —Å—Ç–∏–ª—å –Ω–µ –æ—Ç–Ω–æ—Å—è—â–µ–≥–æ—Å—è –∫ –±–∞–≥—É –∫–æ–¥–∞",
            "–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ‚Äî –∑–∞–¥–∞—Ç—å 1‚Äì2 —Ç–æ—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞"
          ];
          state.format = "–º–∞—Ä–∫–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫";
          state.checks = ["–ø–∞—Ç—á –º–∏–Ω–∏–º–∞–ª–µ–Ω", "–ø—Ä–∏—á–∏–Ω–∞ –ø–æ–Ω—è—Ç–Ω–∞", "–Ω–µ—Ç –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤"];
          state.userInputPlaceholder = "{{—Ñ–∞–π–ª –∏ –æ—à–∏–±–∫–∞}}";
        }
      },
      {
        name:"–°–∏–Ω—Ç–µ–∑ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π",
        apply: ()=>{
          state.role = "–ù–∞—É—á–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä";
          state.goal = "–°–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞—Ç—å 3‚Äì5 –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ–∑–∏—Å–æ–≤ –ø–æ —Ç–µ–º–µ";
          state.context = "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏";
          state.rules = [
            "–∫–∞–∂–¥—ã–π —Ç–µ–∑–∏—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å —Å—Å—ã–ª–∫–æ–π (–µ—Å–ª–∏ –µ—Å—Ç—å)",
            "–æ—Ç–º–µ—á–∞—Ç—å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è",
            "–∏–∑–±–µ–≥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω—ã—Ö –≤—ã–≤–æ–¥–æ–≤ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö"
          ];
          state.citation = "—Å—Ç—Ä–æ–≥–∏–µ —Ü–∏—Ç–∞—Ç—ã —Å –∞—Ç—Ä–∏–±—É—Ü–∏–µ–π";
          state.format = "—Ç–∞–±–ª–∏—Ü–∞ (Markdown)";
          state.userInputPlaceholder = "{{–≤—ã–¥–µ—Ä–∂–∫–∏ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤}}";
        }
      },
      {
        name:"–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–µ –ø–∏—Å—å–º–æ B2B",
        apply: ()=>{
          state.role = "B2B‚Äë–∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä";
          state.goal = "–ù–∞–ø–∏—Å–∞—Ç—å –ø–∏—Å—å–º–æ‚Äë–ø—Ä–æ–¥–∞–∂—É —Å CTA";
          state.tone = "–¥–µ–ª–æ–≤–æ–π";
          state.length = "–∫—Ä–∞—Ç–∫–æ";
          state.rules = [
            "–æ–¥–Ω–∞ –∫–ª—é—á–µ–≤–∞—è –≤—ã–≥–æ–¥–∞",
            "–æ–¥–Ω–∞ –ø—Ä–æ—Å—å–±–∞ –æ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ (CTA)",
            "–±–µ–∑ –≥–∏–ø–µ—Ä–±–æ–ª –∏ –∂–∞—Ä–≥–æ–Ω–∞"
          ];
          state.format = "—Å–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç";
          state.userInputPlaceholder = "{{–ø—Ä–æ–¥—É–∫—Ç –∏ –¶–ê}}";
        }
      }
    ];

    function openLibrary(){
      const sheet = el("div", {id:"sheet"});
      Object.assign(sheet.style, {
        position:"fixed", inset:"0", background:"rgba(0,0,0,.5)", display:"grid",
        placeItems:"center", zIndex:100
      });
      const card = el("div", {className:"panel", style:"width:760px; max-width:95vw;"});
      card.appendChild(el("h3", {textContent:"–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤"}));
      const content = el("div", {className:"content"});
      const grid = el("div", {className:"row3"});
      templates.forEach(t=>{
        const b = el("button", {className:"btn", textContent:t.name, style:"height:64px"});
        b.addEventListener("click", ()=>{
          t.apply();
          bindInputs(); updatePreview(); document.body.removeChild(sheet); toast("–®–∞–±–ª–æ–Ω –ø—Ä–∏–º–µ–Ω—ë–Ω");
        });
        grid.appendChild(b);
      });
      content.appendChild(grid);
      content.appendChild(el("div", {className:"hr"}));
      content.appendChild(el("div", {className:"small muted", innerHTML:"–®–∞–±–ª–æ–Ω—ã –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏."}));
      card.appendChild(content);
      sheet.addEventListener("click", (e)=>{ if (e.target===sheet) document.body.removeChild(sheet); });
      sheet.appendChild(card); document.body.appendChild(sheet);
    }

    // --- Boot ---
    loadLocal(); loadFromHash();
    bindInputs(); renderPatterns(); renderBundles(); updatePreview();
    $("#btnCopy").addEventListener("click", copyPrompt);
    $("#btnExport").addEventListener("click", exportJSON);
    $("#fileImport").addEventListener("change", (e)=> e.target.files[0] && importJSON(e.target.files[0]));
    $("#btnShare").addEventListener("click", shareLink);
    $("#btnLibrary").addEventListener("click", openLibrary);
    $("#btnAgents").addEventListener("click", generateAgentSet);
  </script>
</body>
</html>